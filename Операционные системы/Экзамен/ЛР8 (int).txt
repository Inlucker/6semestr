Лаба 8
*Показать в коде что линия прерывания разделяется
-(IRQ_SHARED)

*Когда выполняется обработчик прерывания?
-При возникновении прерывания при отпускания клавиши

*Когда выполняется тасклет?
-После обработчика аппаратного прерывания

*Когда выполняется work?
-Когда до неё дойдёт очередь

* чем характеризуется аппаратное прерывание:
-когда выполняется аппаратное прерывание, то другие прерывания запрещены на данном процессоре,
-а на других процессорах тоже запрещены на данной линии IRQ

*полный контекст - аппаратный + указатели на структуры ядра, которые описывают выделенные процессу ресурсы

*аппаратный контекст - содержимое регистров, которые нужно сохранить для продолжения выполнения процесса

*линия irq - выделенная линия, по которой обработчику прерываний передаётся информация о прерывании

*request_irq - регистрация обработчика прерывания
*KEYB_IRQ - номер irq
*(irq_handler_t) interrupt_handler - наш обработчик
*"tasklet", /*имя устройства*/
*(void*) (interrupt_handler)); // адресс обработчика прерывания

*Структура тасклета
-state - состояние тасклета (0 - не запланирован, 1 - запланирован на выполнение, 2 - выполняется)
-count - счетчик ссылок на тасклет
-data - аргумент функции обработчика тасклета

*tasklet_schedule - запланировать тасклет на выполнение

*первый воркер обрабатывает нажатие клавиши, выводит, какая клавиша нажата

*второй воркер блокируется, выводит до и после блокировки

*чем отличается тасклет от воркера?
-тасклет - выполняется в контексте прерывания, поэтому его нельзя заблокировать
-воркер - выполняется в контексте потоков ядра, поэтому его можно заблокировать

*На каком процессе по умолчанию тасклет
-на том, на котором выполняется аппаратное прерывание

*Выделенная линия irq - эта та линия, на которую конкретное устройство посылает сигнал прерываний.
Она выделяется конкретному устройству и по этой линии устройство посылает сигнал прерывания на контроллер прерывания.

*Драйверы регистрируют обработчик аппаратного прерывания и
разрешают определенную линию irq посредством функции request_irq

*какие действия вы выполняете в вашем обработчике аппаратного прерывания
-планируем отложенный вызов, то есть тасклет

*покажите, что ваши линии irq разделяются, какой флаг для этого использовали и где
-(IRQ_SHARED) 61 строка тасклет

*сколько у вас workов
-2

*shedule - планирует выполнение аппартного прерывания

*какие действия нужно выполнить, чтобы ваши workи в итоге выполнились (work)
-инициализирую модуль
-создаем очередь
-инициализируем work
-добавляем в очередь

*покажите код вашего обработчика аппаратного прерывания
-interrupt_handler

*что вы сделали чтобы зарегистрировать в системе свой обработчик аппаратного прерывания и обработчик какого прерывания
-вызвали request_irq

*когда будет выполнен ваш тасклет и на каком процессоре
-по завершению обработчика аппаратного прерывания. На том, на котором выполняется аппаратное прерывание


*Цирюлик 160 - тасклет 162 - очереди

*Разделяет Установленный в системе и наш

Вопросы:
2 в Стейт что означает - тасклет выполняется
Тасклет может быть запланирован много раз, выполнен только 1
Когда вызывается аппаратное прерывание - по отжатии клавиши

Что делаем в своем обработчике аппаратного прерывания с тасклетом - планируем (tasklet_schedule)
Будет выполнен после завершения работы обработчика аппаратного прерывания, на том же процессоре на котором выполнялся наш обработчик
Действия по коду:
Инициализируем тасклет
С помощью request_irq регистрируем в системе свой обработчик аппаратного прерывания, передаем my_handler
В my_hadler планируем тасклет (tasklet_schedule)

Воркеры:

Где можем увидеть в системе данный обработчик прерывания (cat /proc/interrupts) - демонстрирует что линия irq разделяется между определенным по умолчанию в системе обработчиком прерывания и нашим обработчиком
Где это написано в коде - устанавливаем флаг irq_shared в функции request_irq (кроме того передаем номер линии irq, наша функция обработки прерывания, имя устройства, адрес обработчика прерывания)
Какие
действия надо выполнить по коду -
создаем очередь,
инициализируем воркеров,
Ставим воркеров в очередь
Когда будут выполнены, кто запланирует, показать в системе